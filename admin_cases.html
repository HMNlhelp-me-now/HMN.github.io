<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | SOS Management</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase.js"></script>

  <link rel="stylesheet" href="css/admin_case.css">
</head>
<body>

  <!-- ‚úÖ ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-title">üö®Management</div>
      <div class="nav-right">
        <a href="admin.html" class="nav-link">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</a>
        <a href="admin_cases.html" class="nav-link active">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </nav>

  <div class="content">
    <h2>üìÖ ‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="caseList"></div>
  </div>

  <script>
  const caseList = document.getElementById("caseList");

  firebase.database().ref("cases").on("value", snap => {
    caseList.innerHTML = "";

    const grouped = {}; // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    snap.forEach(child => {
      const c = child.val();
      const time = new Date(c.timestamp || Date.now());
      const dateKey = time.toLocaleDateString("th-TH", { year: 'numeric', month: 'long', day: 'numeric' });

      if(!grouped[dateKey]) grouped[dateKey] = [];
      grouped[dateKey].push({
        ...c,
        time: time.toLocaleTimeString("th-TH", { hour: '2-digit', minute: '2-digit' })
      });
    });

    // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
    Object.keys(grouped).reverse().forEach(date => {
      const cases = grouped[date];

      const section = document.createElement("div");
      section.classList.add("case-section");
      section.innerHTML = `<h3>üìÜ ${date}</h3>`;

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
            <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody>
          ${cases.map(c => `
            <tr>
              <td>${c.time}</td>
              <td>${c.name || '-'}</td>
              <td>${c.phone || '-'}</td>
              <td>${c.incident || '-'}</td>
              <td>${c.detail || '-'}</td>
              <td>${statusLabel(c.status)}</td>
            </tr>
          `).join("")}
        </tbody>
      `;

      section.appendChild(table);
      caseList.appendChild(section);
    });
  });

  function statusLabel(status){
    if(status === "pending") return "‚è≥ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô";
    if(status === "assigned") return "üöó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
    if(status === "done") return "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
    return "-";
  }

  function logout(){
    firebase.auth().signOut().then(()=>{
      location.href = "index.html";
    });
  }
  </script>
</body>
</html>
